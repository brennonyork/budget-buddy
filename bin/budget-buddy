#!/usr/bin/env sh

# Handles operations in this order:
# 1. 'transform' the columns to be in the correct order and only
#    containing the columns needed
# 2. remove the header from the file (if it exists)
# 3. determine the maximum date from the file
# 4. use the maximum date to rename the file so we can avoid
#    naming conflicts after we've processed, useful given statements
#    all start at different dates. this program *does not* dedupe
#    individual transactions therefore needs to ensure we process each
#    record exactly once and max date matches each statement
# 5. merge all clean files from various financial sources into a single
#    unified file
# 6. sort the single file by date (1st column)
# 7. cut the file up into monthly files starting and ending within the
#    month (to remove the problem of various statements starting and
#    ending at different times)
# 8. for each monthly file apply the category rulesets

# Grab the directory of this script
# - from https://stackoverflow.com/a/246128
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd)"

# Staging (temporary), output, and ruleset directories
TMP_DIR="${DIR}/../tmp"
OUTPUT_DIR="${DIR}/../output"
RULESETS_DIR="${DIR}/../rulesets"
MERGE_FILE="${TMP_DIR}/merged.csv"

# Settings that can be set through the command line
VERBOSE=""
SEARCH_DIR=""

# Source in the core functions from the lib/ directory
source "${DIR}/../lib/transform.sh"
source "${DIR}/../lib/help.sh"

# Command line parser for the help option
#  $ budget-buddy --help
#  $ budget-buddy -h
if [ "${1}" = "--help" ] || [ "${1}" = "-h" ]; then
    print_help
    exit 0
fi

# Command line parser
#   $ budget-buddy [ opts ] -f <file> -n <finance source>
while (( "$#" )); do
    case "${1}" in
	"-v" | "--verbose")
	    VERBOSE="1"
	    shift
	    ;;
	"-d" | "--directory")
	    SEARCH_DIR="${2}"
	    shift 2
	    ;;
	*)
	    printf "WARN: Unrecognized option ${1}\n"
	    shift
	    ;;
    esac
done

# Really bad/sad way to check if an element is in a bash array :(
for fin_src in "${FINANCE_SOURCES[@]}"; do
    if [ "${FIN_SRC_PROVIDED}" = "${fin_src}" ]; then
	FIN_SRC_PRESENT=1
    fi
done

mkdir -p "${TMP_DIR}"
mkdir -p "${OUTPUT_DIR}"

for fin_src in "${FINANCE_SOURCES[@]}"; do
    mkdir -p "${TMP_DIR}/${fin_src}"
done

for line in $(find "${SEARCH_DIR}" -type f); do
    # grab the filename from the absolute path
    filename="$(basename ${line})"
    # grab the first line from the file and trim non-ascii chars
    title="$(head -1 $line | tr -d '[:cntrl:]')"
    
    # we can't use case statements w/regex so we run multi-line
    # if statements :grimace:

    # lets start w chase
    if [[ "${filename}" \
	      =~ ^Chase[0-9]{4}_Activity.*\.CSV$ ]] &&
	   [ "${title}" \
		 = "Transaction Date,Post Date,Description,Category,Type,Amount" ]; then
	echo "chase"
	handle_single_file "${TMP_DIR}/chase" \
			   "${OUTPUT_DIR}/chase" \
			   "${RULESETS_DIR}" \
			   "${line}" \
			   "chase" \
			   "true" \
			   "%M/%d/%Y"
	# capital one
    elif [[ "${filename}" \
		=~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}_transaction_download.* ]] &&
	     [ "${title}" \
		   = "Transaction Date,Posted Date,Card No.,Description,Category,Debit,Credit" ]; then
	echo "capital one"
	handle_single_file "${TMP_DIR}/c1" \
			   "${OUTPUT_DIR}/c1" \
			   "${RULESETS_DIR}" \
			   "${line}" \
			   "c1" \
			   "true" \
			   "%Y-%M-%d"
	# usaa
    elif [[ "${filename}" =~ ^bk_download.*\.csv$ ]]; then
	echo "usaa"
	handle_single_file "${TMP_DIR}/usaa" \
			   "${OUTPUT_DIR}/usaa" \
			   "${RULESETS_DIR}" \
			   "${line}" \
			   "usaa" \
			   "false" \
			   "%M/%d/%Y"
	# bank of america
    elif [[ "${filename}" =~ ^.*[0-9]{4}_[0-9]{4}\.csv$ ]] &&
	     [ "${title}" \
		   = "Posted Date,Reference Number,Payee,Address,Amount" ]; then
	echo "boa"
	handle_single_file "${TMP_DIR}/boa" \
			   "${OUTPUT_DIR}/boa" \
			   "${RULESETS_DIR}" \
			   "${line}" \
			   "boa" \
			   "true" \
			   "%M/%d/%Y"
    fi
done

# 5. merge all clean files from various financial sources into a single
#    unified file
for file in $(find "${TMP_DIR}" -type f); do
    cat "${file}" >> "${MERGE_FILE}"
done

# 6. sort the single file by date (1st column)
sort --reverse "${MERGE_FILE}" > "${MERGE_FILE}.sorted"
mv "${MERGE_FILE}.sorted" "${MERGE_FILE}"

# 7. cut the file up into monthly files starting and ending within the
#    month (to remove the problem of various statements starting and
#    ending at different times)
split_files_by_month "${MERGE_FILE}" "${OUTPUT_DIR}"

# 8. for each monthly file apply the category rulesets
ruleset_transform "${RULESETS_DIR}"

# Clean up!
rm -rf "${TMP_DIR}"
